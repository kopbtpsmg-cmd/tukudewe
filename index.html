<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Tuku Dewe Yo</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }

    .menu-item, .cart-item {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
    }

    .btn {
      padding: 8px 12px;
      background: black;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    .btn-danger { background: red; }

    .tab-btn {
      padding: 10px 16px;
      border: none;
      cursor: pointer;
      background: #ddd;
      font-weight: bold;
      border-radius: 5px;
    }

    .tab-btn.active {
      background: black;
      color: white;
    }

    #confirmPage {
      display:none;
      padding:20px;
      border:1px solid #aaa;
      margin-top:20px;
      border-radius:10px;
      background:#f8f8f8;
    }
  </style>
</head>

<body>

<!-- ========= TAB BUTTON ========= -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
  <button id="btnMenu" class="tab-btn active" onclick="showTab('menuTab')">Menu</button>
  <button id="btnCart" class="tab-btn" onclick="showTab('cartTab')">Keranjang</button>
</div>

<!-- ========= HALAMAN MENU ========= -->
<div id="menuTab">
  <h2>Daftar Menu</h2>
  <div id="menu"></div>
</div>

<hr>

<!-- ========= HALAMAN KERANJANG ========= -->
<div id="cartTab" style="display:none;">
  <h2>Keranjang</h2>

  <div id="cart"></div>

  <p><strong>Total:</strong> Rp <span id="grandTotal">0</span></p>

  <hr>

  <h3>Metode Pembayaran</h3>
  <select id="paymentMethod" style="padding:8px; width:100%;">
    <option value="cash">CASH</option>
    <option value="qris">QRIS</option>
  </select>

  <h3>Data Pelanggan</h3>
  <input id="pelanggan" placeholder="Nama pelanggan" style="width:100%; padding:8px;"><br><br>

  <textarea id="catatan" placeholder="Catatan (opsional)" rows="3" style="width:100%; padding:8px;"></textarea><br><br>

  <button class="btn" onclick="submitOrder()">Kirim Pesanan</button>

  <!-- ===== HALAMAN KONFIRMASI PEMBAYARAN ===== -->
  <div id="confirmPage">
    <h3 id="confirmText"></h3>

    <input id="kodeKasir"
           placeholder="Masukkan kode kasir"
           style="padding:10px; width:100%; margin-top:10px; border:1px solid #ccc; border-radius:5px;">

    <br><br>

    <button class="btn" onclick="confirmPayment()" style="width:100%;">Konfirmasi</button>
  </div>
</div>


<!-- ============================== -->
<!--  JAVASCRIPT  -->
<!-- ============================== -->
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLTJ6Ujf060PI_RRno_XnM-PngyBhKQlL6BvS5tmCcYUyzY-UP20lKD-ueiI7jtAA6Cg/exec";  // <== GANTI WAJIB

let menu = [];
let cart = [];
let lastOrderId = "";   // untuk update pembayaran


// ===========================
// 1. AMBIL MENU DARI GAS
// ===========================
fetch(SCRIPT_URL)
  .then(res => res.text())
  .then(txt => {
    let data;
    try { data = JSON.parse(txt); }
    catch (e) { return console.error("JSON rusak:", e); }

    menu = data;
    renderMenu();
  });


// ===========================
// 2. TAMPILKAN MENU
// ===========================
function renderMenu() {
  const box = document.getElementById("menu");
  box.innerHTML = "";

  menu.forEach(item => {
    box.innerHTML += `
      <div class="menu-item">
        <strong>${item.name}</strong><br>
        Harga: Rp ${item.price}<br><br>
        <button class="btn" onclick="addToCart(${item.id})">Tambah</button>
      </div>
    `;
  });
}


// ===========================
// 3. TAMBAH KE KERANJANG
// ===========================
function addToCart(id) {
  const item = menu.find(m => m.id === id);
  if (!item) return;

  const exist = cart.find(c => c.id === id);
  if (exist) exist.qty++;
  else cart.push({ ...item, qty: 1 });

  renderCart();
}


// ===========================
// 4. TAMPILKAN KERANJANG
// ===========================
function renderCart() {
  const box = document.getElementById("cart");
  box.innerHTML = "";

  cart.forEach(item => {
    box.innerHTML += `
      <div class="cart-item">
        ${item.name}<br>
        Rp ${item.price} Ã— ${item.qty}
        = <strong>Rp ${item.price * item.qty}</strong><br><br>

        <button class="btn" onclick="changeQty(${item.id}, 1)">+</button>
        <button class="btn btn-danger" onclick="changeQty(${item.id}, -1)">-</button>
      </div>
    `;
  });

  const total = cart.reduce((a, b) => a + b.price * b.qty, 0);
  document.getElementById("grandTotal").innerText = total.toLocaleString();
}


// ===========================
// 5. UBAH JUMLAH ITEM
// ===========================
function changeQty(id, amount) {
  const item = cart.find(c => c.id === id);
  if (!item) return;

  item.qty += amount;
  if (item.qty <= 0) cart = cart.filter(c => c.id !== id);

  renderCart();
}


// ===========================
// 6. KIRIM ORDER
// ===========================
function submitOrder() {
  if (cart.length === 0) return alert("Keranjang kosong!");

  const pelanggan = document.getElementById("pelanggan").value || "Tamu";
  const catatan = document.getElementById("catatan").value || "";
  const metode = document.getElementById("paymentMethod").value;

  const orderId = generateOrderId();
  lastOrderId = orderId;

  const payload = {
    pelanggan,
    catatan,
    metode,
    keterangan: "",
    orderId,
    items: cart.map(i => ({
      name: i.name,
      qty: i.qty,
      price: i.price,
      total: i.price * i.qty
    }))
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  })
  .then(() => {
    const totalBelanja = cart.reduce((a, b) => a + b.price * b.qty, 0);
    showPaymentConfirmation(totalBelanja, metode);
  });
}


// ===========================
// 7. TAMPILKAN KONFIRMASI
// ===========================
function showPaymentConfirmation(total, metode) {
  document.getElementById("confirmText").innerHTML =
    `Harap bayar <b>${metode.toUpperCase()}</b> sebesar <b>Rp ${total.toLocaleString()}</b>`;

  document.getElementById("confirmPage").style.display = "block";

  window.scrollTo(0, document.body.scrollHeight);
}


// ===========================
// 8. KONFIRMASI PEMBAYARAN
// ===========================
function confirmPayment() {
  const kode = document.getElementById("kodeKasir").value.trim();
  if (!kode) return alert("Kode kasir wajib diisi!");

  const payload = {
    aksi: "update_status",
    orderId: lastOrderId,
    kodeKasir: kode
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  })
  .then(() => {
    alert("Pembayaran berhasil dikonfirmasi!");
    document.getElementById("confirmPage").style.display = "none";
    cart = [];
    renderCart();
  });
}


// ===========================
// 9. GENERATE ORDER ID
// ===========================
function generateOrderId() {
  return "ORD-" + Date.now() + "-" + Math.floor(Math.random() * 9999);
}


// ===========================
// 10. TAB MENU / KERANJANG
// ===========================
function showTab(id) {
  document.getElementById("menuTab").style.display = "none";
  document.getElementById("cartTab").style.display = "none";

  document.getElementById(id).style.display = "block";

  document.getElementById("btnMenu").classList.remove("active");
  document.getElementById("btnCart").classList.remove("active");

  if (id === "menuTab") document.getElementById("btnMenu").classList.add("active");
  else document.getElementById("btnCart").classList.add("active");
}

</script>

</body>
</html>
